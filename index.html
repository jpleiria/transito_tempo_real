<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trânsito em Tempo Real</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: 'Chakra Petch', sans-serif; }
        #map { height: 100vh; width: 100vw; z-index: 1; background: #09090b; cursor: crosshair; }

        /* --- TÍTULO --- */
        #dashboardTitle {
            position: absolute; top: 20px; left: 20px; z-index: 2000;
            font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 1.6rem;
            color: #fff; text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            background: rgba(15, 23, 42, 0.85); padding: 10px 20px; border-radius: 4px;
            border-left: 5px solid #3b82f6; pointer-events: none; letter-spacing: 2px;
        }

        #dashboardTitle span {
            display: block;
        }

        .title-main {
            font-size: 1.6rem;
        }

        .title-sub {
            font-size: 1.2rem;
            letter-spacing: 3px;
            opacity: 0.75;
        }

   /* --- LOGOS E RELÓGIO (Adicionados abaixo do título) --- */
        .header-assets { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .header-assets img { height: 40px; width: auto; }
        
        #digitalClock {
            font-family: 'Orbitron', sans-serif; color: #3b82f6;
            font-size: 2rem; font-weight: 700; border-top: 1px solid rgba(59, 130, 246, 0.3);
            margin-top: 10px; padding-top: 8px;
        }

        /* --- JANELA DE LUPA PRO --- */
        #zoomWindow {
            position: absolute; top: 20px; right: 20px;
            width: 450px; height: 450px; z-index: 2000;
            background: #0f172a; border: 2px solid #3b82f6; border-radius: 4px;
            box-shadow: 0 0 30px rgba(0,0,0,0.9); overflow: hidden; display: flex; flex-direction: column;
        }
        #miniMapContainer { position: relative; flex-grow: 1; width: 100%; height: 100%; }
        #miniMap { width: 100%; height: 100%; background: #1e293b; }
        .scanline { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%); background-size: 100% 4px; pointer-events: none; z-index: 1000; opacity: 0.4; }
        
        #timerBar { height: 3px; background: #1e293b; width: 100%; }
        #timerFill { height: 100%; background: #3b82f6; width: 0%; transition: width 0.1s linear; }

        #zoomLabel { background: #0f172a; color: #3b82f6; padding: 12px 15px; font-family: 'Orbitron'; font-size: 1rem; text-align: center; border-top: 1px solid #334155; display: flex; justify-content: space-between; }

        /* --- WIDGETS LADO ESQUERDO --- */
        .widget-box {
            background: rgba(15, 23, 42, 0.95); border: 1px solid #334155;
            padding: 12px 20px; border-radius: 4px; pointer-events: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.8); width: fit-content;;
        }
        .widget-label { color: #94a3b8; font-size: 0.7rem; letter-spacing: 1px; font-family: 'Orbitron'; margin-bottom: 4px; }
        .widget-value { color: #fff; font-size: 1.1rem; font-weight: 700; }
        
        #weatherWidget { position: absolute; bottom: 340px; left: 20px; z-index: 2000; border-left: 5px solid #22c55e; }
        #riskWidget { position: absolute; bottom: 250px; left: 20px; z-index: 2000; border-left: 5px solid #64748b; }
        .map-legend { position: absolute; bottom: 25px; left: 20px; z-index: 2000; }

        .legend-title { font-weight: bold; margin-bottom: 5px; color: #fff; border-bottom: 1px solid #475569; padding-bottom: 3px; font-size: 0.8rem; }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; font-size: 0.8rem; color: #cbd5e1; }
        .line { width: 20px; height: 4px; border-radius: 2px; }

        .cb-badge { background-color: #dc2626; color: #fff; border: 2px solid #fff; border-radius: 4px; font-weight: 700; font-size: 11px; padding: 2px 4px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        #statusMsg { position: absolute; bottom: 5px; right: 5px; z-index: 3000; color: #64748b; font-size: 0.65rem; font-family: 'Orbitron'; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="dashboardTitle">
        <span class="title-main">TRÂNSITO<br>EM TEMPO REAL</span>
        <span class="title-sub">LEIRIA</span>
 <div class="header-assets">
            <img src="leiria.png" alt="Logo 1">
            <img src="logo.png" alt="Logo 2">
            <img src="logo3.png" alt="Logo 3">
        </div>

        <div id="digitalClock">00:00:00</div>
    </div>

    </div>
    <div id="zoomWindow">
        <div id="miniMapContainer"><div id="miniMap"></div><div class="scanline"></div></div>
        <div id="timerBar"><div id="timerFill"></div></div>
        <div id="zoomLabel"><span id="spotName">A INICIAR...</span><span id="modeBadge">LIVE</span></div>
    </div>

    <div class="widget-box" id="weatherWidget">
        <div class="widget-label"><i class="fa-solid fa-cloud-bolt"></i> AVISOS METEOROLÓGICOS</div>
        <div class="widget-value" id="weatherValue">VERIFICANDO...</div>
        <div style="font-size:0.7rem; color:#64748b">DISTRITO DE LEIRIA</div>
    </div>

    <div class="widget-box" id="riskWidget">
        <div class="widget-label"><i class="fa-solid fa-fire"></i> RISCO INCÊNDIO</div>
        <div class="widget-value" id="riskValue">--</div>
        <div style="font-size:0.7rem; color:#64748b">CONCELHO DE LEIRIA</div>
    </div>

    <div class="widget-box map-legend">
        <div class="legend-title">TRÂNSITO TEMPO REAL</div>
        <div class="legend-item"><span class="line" style="background:#22c55e"></span> Fluido</div>
        <div class="legend-item"><span class="line" style="background:#f59e0b"></span> Lento</div>
        <div class="legend-item"><span class="line" style="background:#ef4444"></span> Parado</div>
        <div class="legend-title" style="margin-top:8px">CORPOS BOMBEIROS</div>
        <div class="legend-item"><span style="width:12px; height:12px; background:#dc2626; border:1px solid #fff; display:inline-block; border-radius:2px;"></span> Bombeiros (CB)</div>
    </div>

    <div id="statusMsg">SCH2ª João Paulo Pereira | CBSL</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/osmtogeojson@3.0.0-beta.4/osmtogeojson.js"></script>

    <script>
        // 1. RELÓGIO
    function updateClock() {
        const now = new Date();
        document.getElementById('digitalClock').innerText = now.toLocaleTimeString('pt-PT');
    }
    setInterval(updateClock, 1000);
    updateClock();

    // 2. CONFIGURAÇÃO DOS MAPAS
    const getTrafficUrl = () => `https://mt1.google.com/vt/lyrs=m,traffic&x={x}&y={y}&z={z}&t=${Date.now()}`;
    
    let currentMainLayer, currentMiniLayer;
    
    // Mapa Principal
    const map = L.map('map', { zoomControl: false, attributionControl: false, zoomSnap: 0 });
    currentMainLayer = L.tileLayer(getTrafficUrl(), { maxZoom: 20 }).addTo(map);
    map.fitBounds([[39.63, -9.02], [39.97, -8.55]]);

    // Mini Mapa (Janela de Zoom)
const miniMap = L.map('miniMap', { 
    zoomControl: false, 
    attributionControl: false, 
    zoomSnap: 0, 
    dragging: false,
    fadeAnimation: false // Desativar animação evita o flash cinzento
});
currentMiniLayer = L.tileLayer(getTrafficUrl(), { 
    maxZoom: 20,
    updateWhenIdle: false 
}).addTo(miniMap);

    const hotSpots = [
        { name: "ROTUNDA - D. DINIS", loc: [39.73926874806997, -8.818065427592712], zoom: 17 },
        { name: "ROTUNDA - FERRUS", loc: [39.76356960495452, -8.782836987121206], zoom: 17 },
        { name: "ROTUNDA - CINEMACITY", loc: [39.74730983237065, -8.82013089411456], zoom: 17 },
        { name: "ROTUNDA - OLIVEIRAS/GRELHA", loc: [39.75472558940458, -8.815825236206226], zoom: 16 },
        { name: "ROTUNDA - HOSPITAL", loc: [39.741332730956756, -8.793057953775264], zoom: 17 },
        { name: "ROTUNDA - CRUZ D´AREIA", loc: [39.7341341099626, -8.808602522815464], zoom: 17 },
        { name: "ROTUNDA - LEIRIASHOPING", loc: [39.73595196099935, -8.823381742940684], zoom: 16 },
        { name: "ROTUNDA - SINALEIRO", loc: [39.74333125740587, -8.806518602151048], zoom: 18 },
        { name: "CRUZAMENTO - CMLEIRIA", loc: [39.741419671031714, -8.810535461363612], zoom: 17 },
        { name: "ROTUNDA - CUF", loc: [39.74546085657325, -8.8176528709753], zoom: 17 },
        { name: "ROTUNDA - VALE LOBOS", loc: [39.73544585705467, -8.799190470413837], zoom: 17 },
        { name: "CRUZAMENTO - PLANALTO", loc: [39.756489811605135, -8.787857207718456], zoom: 18 }
    ];

    let currentSpotIndex = 0;
    const ROTATION_TIME = 5000;
    let timeLeft = ROTATION_TIME;
    let lastFrameTime = Date.now();

    // 3. CICLO DE ANIMAÇÃO
    function gameLoop() {
        requestAnimationFrame(gameLoop);
        const now = Date.now();
        const dt = now - lastFrameTime;
        lastFrameTime = now;
        timeLeft -= dt;
        
        document.getElementById('timerFill').style.width = `${Math.max(0, (timeLeft / ROTATION_TIME) * 100)}%`;
        
        if (timeLeft <= 0) {
            currentSpotIndex = (currentSpotIndex + 1) % hotSpots.length;
            updateSpot();
        }
    }

    function updateSpot() {
    const spot = hotSpots[currentSpotIndex];
    
    // Força o mapa a reconhecer o seu tamanho real antes de mudar a vista
    miniMap.invalidateSize();
    
    // Mudar a localização
    miniMap.setView(spot.loc, spot.zoom, { animate: false });
    
    document.getElementById('spotName').innerText = spot.name;
    timeLeft = ROTATION_TIME;
}

    // 4. ATUALIZAÇÃO DO TRÂNSITO (RESOLVE O PROBLEMA DO MAPA SUMIR)
    function seamlessRefresh() {
    const newUrl = getTrafficUrl();
    
    // Atualiza o mapa principal (aqui o método antigo funciona bem)
    const nextMain = L.tileLayer(newUrl, { maxZoom: 20 }).addTo(map);
    nextMain.on('load', () => {
        if (currentMainLayer) map.removeLayer(currentMainLayer);
        currentMainLayer = nextMain;
    });

    // NO MINI MAPA: Apenas trocamos a URL da camada atual
    // Isto evita que o mapa fique "vazio" ao repetir o ciclo
    if (currentMiniLayer) {
        currentMiniLayer.setUrl(newUrl);
    }

        // Novo layer para o mini mapa
        const nextMini = L.tileLayer(url, { maxZoom: 20 }).addTo(miniMap);
        nextMini.on('load', () => {
            if (currentMiniLayer) miniMap.removeLayer(currentMiniLayer);
            currentMiniLayer = nextMini;
            // Garante que a vista atual é mantida após a troca de camada
            const spot = hotSpots[currentSpotIndex];
            miniMap.setView(spot.loc, spot.zoom, { animate: false });
        });
    }

    // 5. FUNÇÕES DE DADOS (Máscara, Incêndio, Alertas)
    async function applyMask() {
        try {
            const response = await fetch('limite.geojson');
            if (!response.ok) return;
            const data = await response.json();
            const world = [[90, -180], [90, 180], [-90, 180], [-90, -180]];
            const hole = L.GeoJSON.coordsToLatLngs(data.features[0].geometry.coordinates, 1);

            L.polygon([world, hole], { 
                color: 'transparent', fillColor: '#09090b', fillOpacity: 0.8, interactive: false 
            }).addTo(map);

            L.geoJSON(data, { 
                style: { color: "#3b82f6", weight: 2, fill: false, interactive: false } 
            }).addTo(map);

            map.fitBounds(L.geoJSON(data).getBounds());
        } catch (e) { console.error("Erro máscara:", e); }
    }

    function addFireStations() {
        const cbs = [
            { code: "1002", lat: 39.741155, lng: -8.800315 },
            { code: "1020", lat: 39.685008, lng: -8.887350 },
            { code: "1022", lat: 39.767401, lng: -8.816472 },
            { code: "1022", lat: 39.882945, lng: -8.837566 },
            { code: "1025", lat: 39.821343, lng: -8.839415 }
        ];
        cbs.forEach(cb => {
            const icon = L.divIcon({ className: 'dummy', html: `<div class="cb-badge">${cb.code}</div>`, iconSize: [35, 20] });
            L.marker([cb.lat, cb.lng], { icon: icon }).addTo(map);
        });
    }

    async function fetchRisk() {
        try {
            const r = await fetch('https://api.ipma.pt/open-data/forecast/meteorology/rcm/rcm-d0.json');
            const d = await r.json();
            const nivel = d.local["1009"]?.data.rcm || 0;
            const info = { 1: {t:"REDUZIDO",c:"#22c55e"}, 2: {t:"MODERADO",c:"#eab308"}, 3: {t:"ELEVADO",c:"#f97316"}, 4: {t:"M. ELEVADO",c:"#ef4444"}, 5: {t:"MÁXIMO",c:"#dc2626"} }[nivel] || {t:"N/D",c:"#64748b"};
            const el = document.getElementById('riskValue');
            el.innerText = info.t; el.style.color = info.c;
            document.getElementById('riskWidget').style.borderLeftColor = info.c;
        } catch(e) {}
    }

    async function fetchAlerts() {
        try {
            const r = await fetch('https://api.ipma.pt/open-data/forecast/warnings/warnings_www.json');
            const d = await r.json();
            const avisos = d.filter(a => a.idAreaAviso === "CDT10");
            const w = document.getElementById('weatherWidget');
            const val = document.getElementById('weatherValue');

            if (avisos.length === 0) {
                val.innerText = "SEM AVISOS"; val.style.color = "#22c55e"; w.style.borderLeftColor = "#22c55e";
            } else {
                const main = avisos.sort((a,b) => ({"Vermelho":3,"Laranja":2,"Amarelo":1}[b.nivel] - {"Vermelho":3,"Laranja":2,"Amarelo":1}[a.nivel]))[0];
                const color = main.nivel === "Vermelho" ? "#dc2626" : (main.nivel === "Laranja" ? "#f97316" : "#fbbf24");
                val.innerText = `${main.nivel.toUpperCase()}: ${main.tipo.toUpperCase()}`; 
                val.style.color = color; w.style.borderLeftColor = color;
            }
        } catch(e) { document.getElementById('weatherValue').innerText = "ERRO API"; }
    }

    // 6. INICIALIZAÇÃO
    applyMask(); 
    addFireStations(); 
    fetchRisk(); 
    fetchAlerts(); 
    updateSpot(); 
    gameLoop();

    // 7. INTERVALOS DE ATUALIZAÇÃO
    setInterval(seamlessRefresh, 60000); // Trânsito a cada 60s
    setInterval(fetchRisk, 3600000);     // Risco Incêndio a cada 1h
    setInterval(fetchAlerts, 1800000);   // Meteorologia a cada 30min
    </script>
</body>
</html>